<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Tracker & Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #aaa; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }
        /* Required fields */
        label.required::after { content: " *"; color: red; }
        /* Images */
        .preview-img { max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 0.375rem; }
        .transaction-img { max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 0.375rem; cursor: pointer; transition: transform 0.2s ease-in-out; }
        .transaction-img:hover { transform: scale(1.05); }
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
        .modal-content { margin: auto; display: block; max-width: 80%; max-height: 80%; }
        .modal-close { position: absolute; top: 20px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; }
        .modal-close:hover, .modal-close:focus { color: #bbb; text-decoration: none; }
        /* Status Badges */
        .status-badge { font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-weight: 600; text-transform: uppercase; margin-left: 8px; white-space: nowrap; }
        .status-pending { background-color: #fffbeb; color: #d97706; border: 1px solid #fef3c7; }
        .status-paid { background-color: #f0fdf4; color: #16a34a; border: 1px solid #dcfce7; }
        /* Dashboard */
        .dashboard-card { background-color: #f9fafb; border: 1px solid #e5e7eb; padding: 1rem; border-radius: 0.5rem; text-align: center; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .dashboard-label { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem; }
        .dashboard-value { font-size: 1.5rem; font-weight: 600; color: #1f2937; }
        /* Highlight */
        .highlight { background-color: yellow; font-weight: bold; }
        /* Login Screen */
        #loginScreen { min-height: 100vh; display: flex; justify-content: center; align-items: center; background-color: #e5e7eb; }
        .auth-box { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); width: 100%; max-width: 28rem; }
        /* Hide main app initially */
        #mainAppContent { display: none; }
        /* Tabs */
        .tab-button { padding: 0.5rem 1rem; border: 1px solid transparent; border-bottom: none; cursor: pointer; background-color: #e5e7eb; color: #4b5563; border-radius: 0.375rem 0.375rem 0 0; margin-right: 2px; transition: background-color 0.2s ease; }
        .tab-button.active { background-color: white; border-color: #d1d5db; border-bottom: 1px solid white; color: #1f2937; font-weight: 500; position: relative; top: 1px; }
        .tab-content { display: none; border: 1px solid #d1d5db; padding: 1.5rem; border-radius: 0 0.375rem 0.375rem 0.375rem; background-color: white; }
        .tab-content.active { display: block; }
        /* Invoice/Challan Items */
        .item-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; flex-wrap: wrap; }
        .item-row input, .item-row select { flex-grow: 1; min-width: 60px; }
        .item-row .w-desc { width: 40%; }
        .item-row .w-qty { width: 10%; }
        .item-row .w-rate { width: 15%; }
        .item-row .w-gst { width: 15%; }
        .item-row .w-amt { width: 15%; text-align: right; padding-right: 0.5rem; }
        .item-row .w-btn { width: 5%; text-align: center; }
         @media (max-width: 768px) {
            .item-row { gap: 0.25rem; }
            .item-row input, .item-row select, .item-row span { font-size: 0.8rem; }
            .item-row .w-desc { width: 100%; margin-bottom: 0.25rem; }
            .item-row .w-qty, .item-row .w-rate, .item-row .w-gst, .item-row .w-amt, .item-row .w-btn { width: auto; flex-grow: 1; min-width: 50px;}
            .item-row .w-btn { flex-grow: 0; }
         }
         /* Print-specific styles */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            @page { size: A4; margin: 1cm; }
            button, input, select, textarea, nav, details summary, #logoutBtn { display: none !important; }
            .no-print { display: none !important; }
        }
        /* Basic table styles for print */
        .print-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 10pt; }
        .print-table th, .print-table td { border: 1px solid #ccc; padding: 4px 6px; text-align: left; }
        .print-table th { background-color: #f2f2f2; font-weight: bold; }
        .print-table td.num { text-align: right; }
        .print-header { text-align: center; margin-bottom: 1rem; }
        .print-header h1 { font-size: 16pt; margin: 0; }
        .print-company-details, .print-customer-details { margin-bottom: 1rem; font-size: 10pt; line-height: 1.3; }
        .print-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 1rem; }
        .print-details-grid div { margin-bottom: 2px; white-space: pre-line; /* Allow line breaks from textarea */ }
        .print-totals { margin-top: 1rem; text-align: right; font-size: 10pt; }
        .print-totals div { margin-bottom: 2px; }
        /* Display Payment Transaction ID */
        .payment-ref { font-size: 0.75rem; color: #4b5563; margin-left: 5px; font-style: italic;}
        /* Company Details Section */
        #companyDetailsSection { background-color: #fefce8; /* bg-yellow-50 */ border: 1px solid #fef08a; /* border-yellow-200 */ }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-100 via-blue-50 to-indigo-100 min-h-screen">

    <div id="loginScreen">
        <div class="auth-box">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Login</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="username" name="username" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" name="password" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition">
                </div>
                <p id="loginError" class="text-red-500 text-sm mb-4 hidden"></p>
                <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Login
                </button>
            </form>
             <p class="text-xs text-red-600 mt-4 text-center font-semibold">NOTE: This login system is NOT secure.</p>
        </div>
    </div>

    <div id="mainAppContent" class="container mx-auto max-w-7xl bg-white p-6 md:p-8 rounded-xl shadow-lg mt-8 mb-8">
        <div class="flex justify-between items-center mb-8 border-b pb-4 no-print">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Document Tracker & Creator</h1>
             <div>
                 <span id="loggedInUser" class="text-sm text-gray-600 mr-4"></span>
                 <button id="logoutBtn" class="py-2 px-4 border border-red-300 shadow-sm text-sm font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                    Logout
                </button>
            </div>
        </div>

        <div class="mb-10 p-6 border border-gray-200 rounded-lg bg-white shadow-sm no-print">
             <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Dashboard</h2>
             <div id="dashboardStats" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                 <div class="dashboard-card"> <div class="dashboard-label">Loading...</div> <div class="dashboard-value">-</div> </div>
             </div>
        </div>

        <div id="companyDetailsSection" class="mb-10 p-6 rounded-lg shadow-sm no-print">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">My Company Details (for Printing)</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1 required">Company Name</label>
                    <input type="text" id="companyName" name="companyName" required class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                 <div>
                    <label for="companyGstin" class="block text-sm font-medium text-gray-700 mb-1 required">Company GSTIN</label>
                    <input type="text" id="companyGstin" name="companyGstin" required class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="md:col-span-2">
                    <label for="companyAddress" class="block text-sm font-medium text-gray-700 mb-1 required">Company Address</label>
                    <textarea id="companyAddress" name="companyAddress" rows="3" required class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter full address, one part per line"></textarea>
                </div>
                <div>
                    <label for="companyState" class="block text-sm font-medium text-gray-700 mb-1 required">Company State</label>
                    <select id="companyState" name="companyState" required class="w-full p-2 border border-gray-300 rounded-md">
                        </select>
                </div>
            </div>
            <div class="mt-4 text-right">
                <button id="saveCompanyDetailsBtn" class="py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                    Save Company Details
                </button>
            </div>
        </div>


        <div class="mb-10 no-print">
            <div class="border-b border-gray-200 mb-[-1px]">
                <nav class="-mb-px flex" aria-label="Tabs">
                    <button class="tab-button active" data-tab="logDocument">Log Existing Document</button>
                    <button class="tab-button" data-tab="createDocument">Create New Document</button>
                </nav>
            </div>

            <div id="logDocumentContent" class="tab-content active">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Log Existing Bill / Challan / Note</h3>
                 <form id="logDocumentForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div> <label for="logDocType" class="block text-sm font-medium text-gray-700 mb-1 required">Document Type</label> <select id="logDocType" name="logDocType" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"> <option value="">-- Select Type --</option> <option value="Purchase Bill">Purchase Bill/Invoice</option> <option value="Credit Note Received">Credit Note (Received)</option> <option value="Debit Note Received">Debit Note (Received)</option> <option value="Delivery Challan Received">Delivery Challan (Received)</option> <option value="Other Logged">Other</option> </select> </div>
                        <div> <label for="logDocDate" class="block text-sm font-medium text-gray-700 mb-1 required">Document Date</label> <input type="date" id="logDocDate" name="logDocDate" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"> </div>
                        <div> <label for="logDocNumber" class="block text-sm font-medium text-gray-700 mb-1 required">Document Number</label> <input type="text" id="logDocNumber" name="logDocNumber" required placeholder="e.g., INV-123, CN-001" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"> </div>
                        <div> <label for="logPartyName" class="block text-sm font-medium text-gray-700 mb-1 required">Party Name</label> <input type="text" id="logPartyName" name="logPartyName" required placeholder="Supplier/Vendor Name" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"> </div>
                        <div> <label for="logPartyGstin" class="block text-sm font-medium text-gray-700 mb-1">Party GSTIN</label> <input type="text" id="logPartyGstin" name="logPartyGstin" placeholder="Optional" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"> </div>
                        <div> <label for="logRefDocNumber" class="block text-sm font-medium text-gray-700 mb-1">Reference Doc No.</label> <input type="text" id="logRefDocNumber" name="logRefDocNumber" placeholder="Optional (e.g., Original Invoice No.)" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"> </div>
                        <div class="md:col-span-2 lg:col-span-3"> <label for="logDescription" class="block text-sm font-medium text-gray-700 mb-1">Description / Particulars</label> <textarea id="logDescription" name="logDescription" rows="2" placeholder="Brief description of goods/services or reason for note" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea> </div>
                        <div> <label for="logTaxableAmount" class="block text-sm font-medium text-gray-700 mb-1">Taxable Amount (INR)</label> <input type="number" id="logTaxableAmount" name="logTaxableAmount" step="0.01" placeholder="0.00" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"> </div>
                        <div> <label for="logCgstAmount" class="block text-sm font-medium text-gray-700 mb-1">CGST (INR)</label> <input type="number" id="logCgstAmount" name="logCgstAmount" step="0.01" placeholder="0.00" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"> </div>
                        <div> <label for="logSgstAmount" class="block text-sm font-medium text-gray-700 mb-1">SGST/UTGST (INR)</label> <input type="number" id="logSgstAmount" name="logSgstAmount" step="0.01" placeholder="0.00" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"> </div>
                        <div> <label for="logIgstAmount" class="block text-sm font-medium text-gray-700 mb-1">IGST (INR)</label> <input type="number" id="logIgstAmount" name="logIgstAmount" step="0.01" placeholder="0.00" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"> </div>
                        <div> <label for="logTotalAmount" class="block text-sm font-medium text-gray-700 mb-1 required">Total Amount (INR)</label> <input type="number" id="logTotalAmount" name="logTotalAmount" step="0.01" required placeholder="0.00" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"> </div>
                        <div> <label for="logDocImage" class="block text-sm font-medium text-gray-700 mb-1">Upload Document Image</label> <input type="file" id="logDocImage" name="logDocImage" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200 transition cursor-pointer"> <img id="logImagePreview" src="#" alt="Image Preview" class="mt-2 preview-img hidden"/> <p class="text-xs text-gray-500 mt-1">Optional. Max size ~1-2MB recommended.</p> </div>
                        <div class="md:col-span-2 lg:col-span-3"> <label for="logRemarks" class="block text-sm font-medium text-gray-700 mb-1">Remarks / Notes</label> <textarea id="logRemarks" name="logRemarks" rows="2" placeholder="Internal notes or additional info" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea> </div>
                    </div>
                    <div class="mt-6 text-right"> <button type="submit" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out"> Log Document </button> </div>
                 </form>
            </div>

            <div id="createDocumentContent" class="tab-content">
                 <h3 class="text-xl font-semibold text-gray-700 mb-4">Create New Invoice / Challan / Note</h3>
                 <div class="border-b border-gray-200 mb-4">
                     <nav class="-mb-px flex space-x-4 overflow-x-auto" aria-label="Create Document Types">
                         <button class="create-type-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600" data-create-type="invoice">Invoice</button>
                         <button class="create-type-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-create-type="challan">Challan</button>
                         <button class="create-type-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-create-type="creditNote">Credit Note</button>
                         <button class="create-type-button whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-create-type="debitNote">Debit Note</button>
                     </nav>
                 </div>

                 <form id="createInvoiceForm" class="create-form active">
                     <h4 class="text-lg font-medium text-gray-600 mb-4">Create Sales Invoice</h4>
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                         <div><label for="createInvDate" class="block text-sm font-medium text-gray-700 mb-1 required">Invoice Date</label><input type="date" id="createInvDate" name="createInvDate" required class="w-full p-2 border border-gray-300 rounded-md"></div>
                         <div><label for="createInvNumber" class="block text-sm font-medium text-gray-700 mb-1 required">Invoice Number</label><input type="text" id="createInvNumber" name="createInvNumber" required placeholder="Auto/Manual INV No." class="w-full p-2 border border-gray-300 rounded-md"></div>
                         <div><label for="createInvPartyName" class="block text-sm font-medium text-gray-700 mb-1 required">Customer Name</label><input type="text" id="createInvPartyName" name="createInvPartyName" required class="w-full p-2 border border-gray-300 rounded-md"></div>
                         <div class="md:col-span-2">
                            <label for="createInvCustomerAddress" class="block text-sm font-medium text-gray-700 mb-1">Customer Address</label>
                            <textarea id="createInvCustomerAddress" name="createInvCustomerAddress" rows="2" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter customer address, one part per line"></textarea>
                         </div>
                         <div>
                            <label for="createInvCustomerState" class="block text-sm font-medium text-gray-700 mb-1 required">Customer State</label>
                            <select id="createInvCustomerState" name="createInvCustomerState" required class="w-full p-2 border border-gray-300 rounded-md inv-item-calc">
                                </select>
                        </div>
                         <div><label for="createInvPartyGstin" class="block text-sm font-medium text-gray-700 mb-1">Customer GSTIN</label><input type="text" id="createInvPartyGstin" name="createInvPartyGstin" placeholder="Optional" class="w-full p-2 border border-gray-300 rounded-md"></div>
                     </div>
                     <hr class="my-6">
                     <h5 class="text-md font-medium text-gray-600 mb-2">Items</h5>
                     <div class="item-row text-xs font-medium text-gray-500 mb-1 hidden md:flex">
                         <div class="w-desc pl-1">Description</div>
                         <div class="w-qty text-center">Qty</div>
                         <div class="w-rate text-center">Rate</div>
                         <div class="w-gst text-center">GST%</div>
                         <div class="w-amt text-right pr-2">Amount</div>
                         <div class="w-btn"></div>
                     </div>
                     <div id="createInvItemsContainer" class="space-y-2 mb-4"></div>
                     <button type="button" id="addInvItemBtn" class="text-sm text-indigo-600 hover:text-indigo-800 mb-4">+ Add Item</button>
                     <hr class="my-6">
                     <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4 text-sm">
                         <div><label class="font-medium text-gray-600">Taxable:</label> <span id="invTaxableTotal">0.00</span></div>
                         <div><label class="font-medium text-gray-600">CGST:</label> <span id="invCgstTotal">0.00</span></div>
                         <div><label class="font-medium text-gray-600">SGST:</label> <span id="invSgstTotal">0.00</span></div>
                         <div><label class="font-medium text-gray-600">IGST:</label> <span id="invIgstTotal">0.00</span></div>
                         <div class="md:col-start-5"><label class="font-bold text-gray-700">Total:</label> <span id="invGrandTotal" class="font-bold">0.00</span></div>
                     </div>
                     <div class="mt-6 text-right"> <button type="submit" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Create Invoice</button> </div>
                 </form>

                 <form id="createChallanForm" class="create-form hidden">
                     <h4 class="text-lg font-medium text-gray-600 mb-4">Create Delivery Challan</h4>
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                         <div><label for="createChallanDate" class="block text-sm font-medium text-gray-700 mb-1 required">Challan Date</label><input type="date" id="createChallanDate" name="createChallanDate" required class="w-full p-2 border border-gray-300 rounded-md"></div>
                         <div><label for="createChallanNumber" class="block text-sm font-medium text-gray-700 mb-1 required">Challan Number</label><input type="text" id="createChallanNumber" name="createChallanNumber" required placeholder="Auto/Manual CH No." class="w-full p-2 border border-gray-300 rounded-md"></div>
                         <div><label for="createChallanPartyName" class="block text-sm font-medium text-gray-700 mb-1 required">Receiver Name</label><input type="text" id="createChallanPartyName" name="createChallanPartyName" required class="w-full p-2 border border-gray-300 rounded-md"></div>
                         <div class="md:col-span-3">
                            <label for="createChallanReceiverAddress" class="block text-sm font-medium text-gray-700 mb-1">Receiver Address</label>
                            <textarea id="createChallanReceiverAddress" name="createChallanReceiverAddress" rows="2" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter receiver address, one part per line"></textarea>
                         </div>
                     </div>
                      <hr class="my-6">
                     <h5 class="text-md font-medium text-gray-600 mb-2">Items Delivered</h5>
                     <div id="createChallanItemsContainer" class="space-y-2 mb-4"></div>
                     <button type="button" id="addChallanItemBtn" class="text-sm text-indigo-600 hover:text-indigo-800 mb-4">+ Add Item</button>
                     <div class="mt-6 text-right"> <button type="submit" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Create Challan</button> </div>
                 </form>

                 <form id="createCreditNoteForm" class="create-form hidden">
                     <h4 class="text-lg font-medium text-gray-600 mb-4">Create Credit Note</h4>
                     <p class="text-gray-500">Credit Note creation form placeholder.</p>
                     <div class="mt-6 text-right"> <button type="submit" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Create Credit Note</button> </div>
                 </form>

                 <form id="createDebitNoteForm" class="create-form hidden">
                     <h4 class="text-lg font-medium text-gray-600 mb-4">Create Debit Note</h4>
                     <p class="text-gray-500">Debit Note creation form placeholder.</p>
                     <div class="mt-6 text-right"> <button type="submit" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Create Debit Note</button> </div>
                 </form>
            </div>
        </div>


        <div class="no-print">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                 <h2 class="text-2xl font-semibold text-gray-700">Logged & Created Documents</h2>
                 <div class="flex gap-4 w-full md:w-auto">
                    <input type="text" id="searchInput" placeholder="Search by Doc No or Tracking ID..." class="flex-grow md:flex-grow-0 w-full md:w-64 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition">
                    <button id="exportCsvBtn" title="Export all documents to CSV" class="flex-shrink-0 py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out"> Export CSV </button>
                 </div>
            </div>
            <div id="transactionList" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 border-t pt-4">
                <p id="noTransactions" class="text-gray-500">No documents logged or created yet.</p>
                <p id="noSearchResults" class="text-gray-500 hidden">No documents match your search.</p>
            </div>
        </div>
    </div>

    <div id="imageModal" class="modal" onclick="closeModalOnClickOutside(event)"> <span class="modal-close" onclick="closeModal()">&times;</span> <img class="modal-content" id="modalImage"> </div>

    <div id="printArea" class="hidden"></div>

    <script>
        // --- Constants ---
        const USERS_STORAGE_KEY = 'appUsers_v2';
        const TRANSACTIONS_STORAGE_KEY = 'transactions_v2';
        const COMPANY_DETAILS_STORAGE_KEY = 'myCompanyDetails_v2'; // Key for company details

        // Default Company Details (if nothing in storage)
        const DEFAULT_COMPANY_DETAILS = {
            name: "Your Company Name",
            address: "123 Your Street\nYour City, Your Pin", // Use \n for line breaks
            gstin: "YOUR_GSTIN_HERE",
            state: "Haryana"
        };

        // Indian States List
        const INDIAN_STATES = [ "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal", "Andaman and Nicobar Islands", "Chandigarh", "Dadra and Nagar Haveli and Daman and Diu", "Lakshadweep", "Delhi", "Puducherry", "Ladakh", "Jammu and Kashmir" ];


        // --- Utility Functions ---
        const $ = (selector) => document.getElementById(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        const formatCurrency = (num) => { const v = parseFloat(num); return !isNaN(v) ? v.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00'; };

        // --- User Management (INSECURE - LocalStorage) ---
        function initializeUsers() { /* ... (no changes needed) ... */
            try { let users = getUsersFromStorage(); let needsSave = false; if (!users.find(u => u.username === 'admin')) { users.push({ username: 'admin', password: 'baba291814', role: 'admin' }); needsSave = true; console.log('Initialized admin.'); } if (!users.find(u => u.username === 'user1')) { users.push({ username: 'user1', password: '123456', role: 'user' }); needsSave = true; console.log('Initialized user1.'); } if (needsSave) saveUsersToStorage(users); } catch (e) { console.error("User init error:", e); }
        }
        function getUsersFromStorage() { try { const d = localStorage.getItem(USERS_STORAGE_KEY); return d ? JSON.parse(d) : []; } catch (e) { console.error("Get users error:", e); return []; } }
        function saveUsersToStorage(users) { try { localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users)); } catch (e) { console.error("Save users error:", e); alert("Could not save user data."); } }

        // --- Company Details Management ---
        function getCompanyDetails() {
            try {
                const details = localStorage.getItem(COMPANY_DETAILS_STORAGE_KEY);
                return details ? JSON.parse(details) : DEFAULT_COMPANY_DETAILS;
            } catch (e) {
                console.error("Error getting company details:", e);
                return DEFAULT_COMPANY_DETAILS; // Return default on error
            }
        }
        function saveCompanyDetails() {
            const details = {
                name: $('companyName')?.value || '',
                address: $('companyAddress')?.value || '',
                gstin: $('companyGstin')?.value || '',
                state: $('companyState')?.value || ''
            };
            // Basic validation
            if (!details.name || !details.address || !details.gstin || !details.state) {
                alert("Please fill in all required Company Details fields.");
                return false;
            }
            try {
                localStorage.setItem(COMPANY_DETAILS_STORAGE_KEY, JSON.stringify(details));
                alert("Company details saved successfully!");
                // Recalculate invoice totals if company state changed
                if ($('createInvoiceForm').classList.contains('active')) {
                    calculateInvoiceTotals();
                }
                return true;
            } catch (e) {
                console.error("Error saving company details:", e);
                alert("Could not save company details.");
                return false;
            }
        }
        function loadCompanyDetailsIntoForm() {
            const details = getCompanyDetails();
            $('companyName').value = details.name;
            $('companyAddress').value = details.address;
            $('companyGstin').value = details.gstin;
            // Populate state dropdown first, then set value
            populateStateDropdowns($('companyState')); // Populate company state dropdown
            $('companyState').value = details.state;
        }

        // --- Login/Logout ---
        function handleLogin(event) { /* ... (no changes needed) ... */
            event.preventDefault(); const username = $('username').value.trim(); const password = $('password').value; const loginErrorEl = $('loginError'); loginErrorEl.classList.add('hidden'); if (!username || !password) { loginErrorEl.textContent = 'Enter username & password.'; loginErrorEl.classList.remove('hidden'); return; } const users = getUsersFromStorage(); const foundUser = users.find(u => u.username === username); if (foundUser && foundUser.password === password) { sessionStorage.setItem('isLoggedIn', 'true'); sessionStorage.setItem('loggedInUsername', foundUser.username); sessionStorage.setItem('userRole', foundUser.role || 'user'); showMainApp(); $('username').value = ''; $('password').value = ''; } else { loginErrorEl.textContent = 'Invalid credentials.'; loginErrorEl.classList.remove('hidden'); }
        }
        function handleLogout() { sessionStorage.clear(); showLoginScreenUI(); }

        // --- UI Switching ---
        function showLoginScreenUI() { $('loginScreen').style.display = 'flex'; $('mainAppContent').style.display = 'none'; }
        function showMainApp() {
            $('loginScreen').style.display = 'none'; $('mainAppContent').style.display = 'block';
            const role = sessionStorage.getItem('userRole'); const username = sessionStorage.getItem('loggedInUsername');
            $('loggedInUser').textContent = `User: ${username} (${role})`;
            loadCompanyDetailsIntoForm(); // Load company details into form
            populateStateDropdowns($('createInvCustomerState')); // Populate customer state dropdown
            displayTransactions($('searchInput') ? $('searchInput').value : '');
            if ($('createInvItemsContainer') && $('createInvItemsContainer').offsetParent !== null && $('createInvItemsContainer').children.length === 0) addInvoiceItemRow();
            if ($('createChallanItemsContainer') && $('createChallanItemsContainer').offsetParent !== null && $('createChallanItemsContainer').children.length === 0) addChallanItemRow();
        }
        function checkInitialLoginState() { if (sessionStorage.getItem('isLoggedIn') === 'true') { showMainApp(); } else { showLoginScreenUI(); } }

        // --- Tab Switching ---
        function switchTab(event) { /* ... (no changes needed) ... */
            const targetTab = event.target.dataset.tab; if (!targetTab) return; $$('.tab-button').forEach(b => b.classList.remove('active')); $$('.tab-content').forEach(c => c.classList.remove('active')); event.target.classList.add('active'); $(targetTab + 'Content').classList.add('active'); if (targetTab === 'createDocument') { if ($('createInvItemsContainer') && $('createInvItemsContainer').offsetParent !== null && $('createInvItemsContainer').children.length === 0) addInvoiceItemRow(); if ($('createChallanItemsContainer') && $('createChallanItemsContainer').offsetParent !== null && $('createChallanItemsContainer').children.length === 0) addChallanItemRow(); }
        }

        // --- Create Document Type Switching ---
         function switchCreateType(event) { /* ... (no changes needed) ... */
             const targetType = event.target.dataset.createType; if (!targetType) return; $$('.create-type-button').forEach(b => { b.classList.remove('border-indigo-500', 'text-indigo-600'); b.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300'); }); $$('.create-form').forEach(f => f.classList.add('hidden')); event.target.classList.add('border-indigo-500', 'text-indigo-600'); event.target.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300'); const targetFormId = 'create' + targetType.charAt(0).toUpperCase() + targetType.slice(1) + 'Form'; $(targetFormId).classList.remove('hidden'); if (targetType === 'invoice' && $('createInvItemsContainer') && $('createInvItemsContainer').children.length === 0) addInvoiceItemRow(); if (targetType === 'challan' && $('createChallanItemsContainer') && $('createChallanItemsContainer').children.length === 0) addChallanItemRow();
         }

        // --- Populate State Dropdowns ---
        function populateStateDropdowns(selectElement) {
            if (!selectElement) return;
            const currentValue = selectElement.value; // Preserve current value if exists
            selectElement.innerHTML = '<option value="">-- Select State --</option>';
            INDIAN_STATES.sort().forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                selectElement.appendChild(option);
            });
            // Restore previous selection or default
            if (INDIAN_STATES.includes(currentValue)) {
                selectElement.value = currentValue;
            } else if (selectElement.id === 'companyState' && INDIAN_STATES.includes(getCompanyDetails().state)) {
                 selectElement.value = getCompanyDetails().state; // Default company state
            } else if (selectElement.id === 'createInvCustomerState' && INDIAN_STATES.includes(getCompanyDetails().state)) {
                 selectElement.value = getCompanyDetails().state; // Default customer state to company state
            }
        }

        // --- Image Preview ---
        function handleImagePreview(event, previewElementId) { /* ... (no changes needed) ... */
             const file = event.target.files[0]; const previewEl = $(previewElementId); if (!previewEl) return; if (file && file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = (e) => { previewEl.src = e.target.result; previewEl.classList.remove('hidden'); }; reader.readAsDataURL(file); } else { previewEl.src = '#'; previewEl.classList.add('hidden'); }
        }

        // --- Load/Save Transactions ---
        function getTransactions() { try { const d = localStorage.getItem(TRANSACTIONS_STORAGE_KEY); return d ? JSON.parse(d) : []; } catch (e) { console.error("Get transactions error:", e); return []; } }
        function saveTransactions(transactions) { try { localStorage.setItem(TRANSACTIONS_STORAGE_KEY, JSON.stringify(transactions)); } catch (e) { console.error("Save transactions error:", e); alert("Could not save transactions."); } }

        // --- Highlight Search Term ---
        function highlightText(text, searchTerm) { if (!text || !searchTerm) return text; const esc = searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'); const rgx = new RegExp(`(${esc})`, 'gi'); return text.replace(rgx, `<span class="highlight">$1</span>`); }

        // --- Display Transactions ---
        function displayTransactions(searchTerm = '') { /* ... (Updated status display logic below) ... */
            if (sessionStorage.getItem('isLoggedIn') !== 'true') return;
            const allTransactions = getTransactions(); const listDiv = $('transactionList'); const noTransP = $('noTransactions'); const noSearchP = $('noSearchResults');
            if (!listDiv || !noTransP || !noSearchP) { console.error("List display elements missing!"); return; }
            listDiv.innerHTML = ''; const normSearch = searchTerm.trim().toLowerCase(); const role = sessionStorage.getItem('userRole');
            const filtered = normSearch ? allTransactions.filter(tx => (tx.docNumber && tx.docNumber.toLowerCase().includes(normSearch)) || (tx.id && tx.id.toLowerCase().includes(normSearch))) : allTransactions;
            noTransP.classList.toggle('hidden', allTransactions.length > 0); noSearchP.classList.toggle('hidden', !(filtered.length === 0 && allTransactions.length > 0));
            if (filtered.length > 0) {
                filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
                filtered.forEach((tx) => {
                    const card = document.createElement('div'); card.className = 'p-4 bg-white rounded-lg shadow-md border border-gray-200 flex flex-col md:flex-row gap-4 relative';
                    const trunc = (s, l) => (s && s.length > l) ? s.substring(0, l) + '...' : s;
                    const isPaid = tx.paymentStatus === 'Paid'; const sBadgeCls = isPaid ? 'status-paid' : 'status-pending';
                    // Updated status text display
                    const sTxt = isPaid ? `Paid ${tx.paymentTransactionId ? `<span class="payment-ref">(Ref: ${tx.paymentTransactionId})</span>` : ''}` : 'Pending';
                    const tglTxt = isPaid ? 'Mark Pending' : 'Mark Paid'; const tglCls = isPaid ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600';
                    const statHTML = tx.paymentStatus !== undefined ? `<span class="status-badge ${sBadgeCls}">${sTxt}</span> <button onclick="togglePaymentStatus('${tx.id}')" title="${tglTxt}" class="text-xs ${tglCls} text-white font-semibold py-1 px-2 rounded shadow hover:shadow-md transition duration-150 ml-2">${tglTxt}</button>` : '';
                    let imgHTML = ''; if (tx.imageDataUrl) { imgHTML = `<img src="${tx.imageDataUrl}" alt="Doc Image" class="transaction-img mt-2 md:mt-0" onclick="openModal('${tx.imageDataUrl}')" onerror="this.style.display='none';">`; }
                    const hiDoc = highlightText(tx.docNumber, normSearch); const hiId = highlightText(tx.id, normSearch);
                    const delBtnHTML = role === 'admin' ? `<button title="Delete" onclick="deleteTransaction('${tx.id}')" class="absolute top-2 right-2 text-red-400 hover:text-red-600 font-bold text-xl leading-none p-1 no-print">&times;</button>` : '';
                    const printBtnHTML = tx.entryMethod === 'Created' ? `<button title="Print Document" onclick="printDocument('${tx.id}')" class="absolute bottom-2 right-2 text-blue-500 hover:text-blue-700 p-1 no-print"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a8.956 8.956 0 0 1-1.11-1.458L9.9 9.9l4.5 4.5 1.458-1.11a8.956 8.956 0 0 1 1.458 1.11m-.096.72a11.959 11.959 0 0 0-1.604 1.604m1.604-1.604 1.458 1.11m-1.458-1.11L15.3 9.9l-4.5 4.5-1.458 1.11M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096L3.75 14.25l-2.25 2.25.041.041a16.875 16.875 0 0 0 4.486 4.486.041.041L9 18.75l-2.25-2.25m9-3.75-2.25-2.25L15 9l2.25 2.25 2.25 2.25-2.25 2.25L15 18.75l-2.25-2.25m9-3.75h-6.75M6.75 9H3.75m3 0V3.75M17.25 9V3.75M3 9h18M3 15h18" /></svg></button>` : '';
                    const itemsDetailsHTML = tx.items && tx.items.length > 0 ? `<details class="text-xs mt-1"><summary class="cursor-pointer text-blue-600">Show Items (${tx.items.length})</summary><ul class="list-disc pl-5 mt-1 text-gray-600">${tx.items.map(item => `<li>${item.description || 'Item'} - Qty: ${item.quantity || 'N/A'} ${item.rate ? `- Rate: ${formatCurrency(item.rate)}` : ''} ${item.gstRate ? `- GST: ${item.gstRate}%` : ''} ${item.amount ? `- Amt: ${formatCurrency(item.amount)}` : ''}</li>`).join('')}</ul></details>` : '';
                    const taxDetailsHTML = tx.type === 'Sales Invoice' ? `<div class="text-xs text-gray-500 mt-1">Taxable: ${formatCurrency(tx.taxableAmount)} | CGST: ${formatCurrency(tx.cgstAmount)} | SGST: ${formatCurrency(tx.sgstAmount)} | IGST: ${formatCurrency(tx.igstAmount)}</div>` : '';

                    card.innerHTML = `
                        <div class="flex-grow space-y-1">
                            <div class="flex justify-between items-center mb-1"> <span class="text-xs font-semibold px-2 py-0.5 rounded ${getTransactionTypeColor(tx.type)}">${tx.type || 'N/A'}</span> <span class="text-sm text-gray-600 font-medium">${tx.date ? new Date(tx.date).toLocaleDateString('en-GB') : 'N/A'}</span> </div>
                            <h3 class="text-lg font-semibold text-gray-800">${tx.partyName || 'N/A'}</h3>
                            <p class="text-sm text-gray-500">Doc No: ${hiDoc || 'N/A'} ${tx.refDocNumber ? `(Ref: ${tx.refDocNumber})` : ''}</p>
                            <p class="text-xs text-gray-400">ID: ${hiId || 'N/A'}</p>
                            ${tx.totalAmount !== undefined ? `<p class="text-sm text-gray-600"><strong>Total: ${formatCurrency(tx.totalAmount)}</strong></p>` : ''}
                            ${taxDetailsHTML}
                            ${tx.paymentStatus !== undefined ? `<div class="text-sm text-gray-600 flex items-center"><strong>Status:</strong> ${statHTML}</div>` : ''}
                            ${tx.description ? `<p class="text-sm text-gray-500 pt-1">Desc: ${trunc(tx.description, 50)}</p>` : ''}
                            ${tx.remarks ? `<p class="text-xs text-gray-400 pt-1 italic">Notes: ${trunc(tx.remarks, 50)}</p>` : ''}
                            ${tx.partyGstin ? `<p class="text-xs text-gray-400 pt-1">GSTIN: ${tx.partyGstin}</p>` : ''}
                            ${itemsDetailsHTML}
                        </div>
                        <div class="flex-shrink-0 w-[100px] h-[100px] flex items-center justify-center md:ml-auto"> ${imgHTML} </div>
                        ${delBtnHTML}
                        ${printBtnHTML}
                    `;
                    listDiv.appendChild(card);
                });
            }
            updateDashboard();
        }

        // --- Update Dashboard ---
        function updateDashboard() { /* ... (no changes needed) ... */
            const txns = getTransactions(); const stats = { totalInvoices: 0, totalChallans: 0, totalCreditNotes: 0, totalDebitNotes: 0, types: {} }; const allTypes = [...new Set(txns.map(t => t.type))]; allTypes.forEach(type => { if(type) stats.types[type] = { count: 0, totalAmount: 0 }; }); txns.forEach(tx => { const amt = parseFloat(tx.totalAmount) || 0; if (tx.type && stats.types[tx.type]) { stats.types[tx.type].count++; stats.types[tx.type].totalAmount += amt; } if (tx.type?.includes('Invoice')) stats.totalInvoices++; if (tx.type?.includes('Challan')) stats.totalChallans++; if (tx.type?.includes('Credit Note')) stats.totalCreditNotes++; if (tx.type?.includes('Debit Note')) stats.totalDebitNotes++; }); const fmtDashC = (n) => n.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0, maximumFractionDigits: 0 }); const dashDiv = $('dashboardStats'); if (!dashDiv) return; dashDiv.innerHTML = ''; const createCard = (label, value, count = null) => `<div class="dashboard-card"><div class="dashboard-label">${label}</div><div class="dashboard-value">${value}</div>${count !== null ? `<div class="text-xs text-gray-400 mt-1">(${count} docs)</div>` : ''}</div>`; if(stats.totalInvoices > 0) dashDiv.innerHTML += createCard('Total Invoices', stats.totalInvoices); if(stats.totalChallans > 0) dashDiv.innerHTML += createCard('Total Challans', stats.totalChallans); if(stats.totalCreditNotes > 0) dashDiv.innerHTML += createCard('Total Credit Notes', stats.totalCreditNotes); if(stats.totalDebitNotes > 0) dashDiv.innerHTML += createCard('Total Debit Notes', stats.totalDebitNotes); allTypes.forEach(type => { if (type && stats.types[type]?.count > 0 && stats.types[type]?.totalAmount > 0) { dashDiv.innerHTML += createCard(`${type} Total Amt`, fmtDashC(stats.types[type].totalAmount), stats.types[type].count); } }); if (dashDiv.children.length === 0) { dashDiv.innerHTML = `<p class="text-gray-500 col-span-full text-center">No data for dashboard.</p>`; }
        }

        // --- Get Color ---
        function getTransactionTypeColor(type) { /* ... (no changes needed) ... */
            if (!type) return 'bg-gray-100 text-gray-800'; if (type.includes('Invoice') || type.includes('Bill')) return 'bg-blue-100 text-blue-800'; if (type.includes('Credit Note')) return 'bg-green-100 text-green-800'; if (type.includes('Debit Note')) return 'bg-yellow-100 text-yellow-800'; if (type.includes('Challan')) return 'bg-purple-100 text-purple-800'; return 'bg-gray-100 text-gray-800';
        }

        // --- Handle Log Document Form ---
        function handleLogDocumentFormSubmit(event) { /* ... (no changes needed) ... */
            event.preventDefault(); const form = $('logDocumentForm'); const imageInput = $('logDocImage'); const previewEl = $('logImagePreview'); const formData = new FormData(form); const transaction = { id: 'tx-' + Date.now() + '-' + Math.random().toString(36).substring(2, 7), entryMethod: 'Logged', type: formData.get('logDocType'), date: formData.get('logDocDate'), docNumber: formData.get('logDocNumber'), partyName: formData.get('logPartyName'), partyGstin: formData.get('logPartyGstin'), refDocNumber: formData.get('logRefDocNumber'), description: formData.get('logDescription'), taxableAmount: formData.get('logTaxableAmount') || '0', cgstAmount: formData.get('logCgstAmount') || '0', sgstAmount: formData.get('logSgstAmount') || '0', igstAmount: formData.get('logIgstAmount') || '0', totalAmount: formData.get('logTotalAmount'), remarks: formData.get('logRemarks'), paymentStatus: 'Pending', imageDataUrl: previewEl && previewEl.src.startsWith('data:image') ? previewEl.src : null }; if (!transaction.type || !transaction.date || !transaction.docNumber || !transaction.partyName || !transaction.totalAmount) { alert('Please fill required fields (*).'); return; } if (isNaN(parseFloat(transaction.totalAmount))) { alert('Total Amount must be a number.'); return; } const transactions = getTransactions(); transactions.push(transaction); saveTransactions(transactions); form.reset(); if(previewEl) { previewEl.src = '#'; previewEl.classList.add('hidden'); } displayTransactions($('searchInput').value); alert('Document logged successfully!'); console.log('Logged:', transaction.id);
        }

        // --- Handle Create Invoice Form ---
         function addInvoiceItemRow() { /* ... (no changes needed) ... */
             const container = $('createInvItemsContainer'); if (!container) return; const itemCount = container.children.length; const row = document.createElement('div'); row.className = 'item-row border-t pt-2'; row.innerHTML = ` <input type="text" name="invItemDesc_${itemCount}" placeholder="Item Description" class="p-1 border rounded text-sm w-desc"> <input type="number" name="invItemQty_${itemCount}" placeholder="Qty" value="1" min="0" step="any" class="p-1 border rounded text-sm w-qty inv-item-calc"> <input type="number" name="invItemRate_${itemCount}" placeholder="Rate" min="0" step="0.01" class="p-1 border rounded text-sm w-rate inv-item-calc"> <select name="invItemGst_${itemCount}" class="p-1 border rounded text-sm w-gst inv-item-calc"> <option value="0">GST 0%</option> <option value="5">GST 5%</option> <option value="12">GST 12%</option> <option value="18" selected>GST 18%</option> <option value="28">GST 28%</option> </select> <span class="item-amount text-sm w-amt">0.00</span> <button type="button" onclick="this.parentElement.remove(); calculateInvoiceTotals();" class="text-red-500 hover:text-red-700 text-xs p-1 w-btn">X</button> `; container.appendChild(row); row.querySelectorAll('.inv-item-calc').forEach(input => input.addEventListener('input', calculateInvoiceTotals)); calculateInvoiceTotals();
         }

         function calculateInvoiceTotals() { /* ... (no changes needed) ... */
             let taxableTotal = 0; let cgstTotal = 0; let sgstTotal = 0; let igstTotal = 0; const customerState = $('createInvCustomerState').value; const myState = getCompanyDetails().state; const isIntraState = customerState && myState && customerState === myState; $$('#createInvItemsContainer .item-row').forEach((row, index) => { const qty = parseFloat(row.querySelector(`input[name="invItemQty_${index}"]`)?.value) || 0; const rate = parseFloat(row.querySelector(`input[name="invItemRate_${index}"]`)?.value) || 0; const gstRate = parseFloat(row.querySelector(`select[name="invItemGst_${index}"]`)?.value) || 0; const amountSpan = row.querySelector('.item-amount'); const amount = qty * rate; if(amountSpan) amountSpan.textContent = amount.toFixed(2); taxableTotal += amount; if (isIntraState) { const itemCgst = amount * (gstRate / 2 / 100); const itemSgst = amount * (gstRate / 2 / 100); cgstTotal += itemCgst; sgstTotal += itemSgst; } else if (customerState && myState) { const itemIgst = amount * (gstRate / 100); igstTotal += itemIgst; } }); const grandTotal = taxableTotal + cgstTotal + sgstTotal + igstTotal; $('invTaxableTotal').textContent = taxableTotal.toFixed(2); $('invCgstTotal').textContent = cgstTotal.toFixed(2); $('invSgstTotal').textContent = sgstTotal.toFixed(2); $('invIgstTotal').textContent = igstTotal.toFixed(2); $('invGrandTotal').textContent = grandTotal.toFixed(2);
         }


        function handleCreateInvoiceFormSubmit(event) {
            event.preventDefault();
            const form = $('createInvoiceForm'); const formData = new FormData(form);
            const customerState = formData.get('createInvCustomerState');
            const myState = getCompanyDetails().state; // Get from storage
            const isIntraState = customerState && myState && customerState === myState;

             const items = []; let finalTaxable = 0; let finalCgst = 0; let finalSgst = 0; let finalIgst = 0;
             $$('#createInvItemsContainer .item-row').forEach((row, index) => {
                 const desc = row.querySelector(`input[name="invItemDesc_${index}"]`)?.value || '';
                 const qty = parseFloat(row.querySelector(`input[name="invItemQty_${index}"]`)?.value) || 0;
                 const rate = parseFloat(row.querySelector(`input[name="invItemRate_${index}"]`)?.value) || 0;
                 const gstRate = parseFloat(row.querySelector(`select[name="invItemGst_${index}"]`)?.value) || 0;
                 if (desc && qty > 0) {
                     const amount = qty * rate; let itemCgst = 0, itemSgst = 0, itemIgst = 0;
                     if (isIntraState) { itemCgst = amount * (gstRate / 2 / 100); itemSgst = amount * (gstRate / 2 / 100); }
                     else if (customerState && myState) { itemIgst = amount * (gstRate / 100); }
                     items.push({ description: desc, quantity: qty, rate: rate, gstRate: gstRate, amount: amount, cgst: itemCgst, sgst: itemSgst, igst: itemIgst });
                     finalTaxable += amount; finalCgst += itemCgst; finalSgst += itemSgst; finalIgst += itemIgst;
                 }
             });

            if (!formData.get('createInvDate') || !formData.get('createInvNumber') || !formData.get('createInvPartyName') || !customerState) { alert('Please fill required Invoice fields (Date, No, Customer Name, Customer State).'); return; }
            if (items.length === 0) { alert('Please add at least one item.'); return; }

            const finalTotal = finalTaxable + finalCgst + finalSgst + finalIgst;
            const transaction = {
                id: 'tx-' + Date.now() + '-' + Math.random().toString(36).substring(2, 7), entryMethod: 'Created', type: 'Sales Invoice',
                date: formData.get('createInvDate'), docNumber: formData.get('createInvNumber'),
                partyName: formData.get('createInvPartyName'), partyGstin: formData.get('createInvPartyGstin'),
                partyAddress: formData.get('createInvCustomerAddress'), // Save customer address
                customerState: customerState, items: items, taxableAmount: finalTaxable.toFixed(2),
                cgstAmount: finalCgst.toFixed(2), sgstAmount: finalSgst.toFixed(2), igstAmount: finalIgst.toFixed(2),
                totalAmount: finalTotal.toFixed(2), paymentStatus: 'Pending', imageDataUrl: null
            };
            const transactions = getTransactions(); transactions.push(transaction); saveTransactions(transactions);
            form.reset(); $('createInvItemsContainer').innerHTML = ''; addInvoiceItemRow();
            calculateInvoiceTotals(); displayTransactions($('searchInput').value);
            alert('Invoice created successfully!'); console.log('Created Invoice:', transaction.id);
         }

         // --- Handle Create Challan Form ---
         function addChallanItemRow() { /* ... (no changes needed) ... */
             const container = $('createChallanItemsContainer'); if (!container) return; const itemCount = container.children.length; const row = document.createElement('div'); row.className = 'item-row border-t pt-2'; row.innerHTML = `<input type="text" name="challanItemDesc_${itemCount}" placeholder="Item Description" class="p-1 border rounded text-sm w-3/4"> <input type="number" name="challanItemQty_${itemCount}" placeholder="Qty" value="1" min="0" step="any" class="p-1 border rounded text-sm w-1/4"> <button type="button" onclick="this.parentElement.remove();" class="text-red-500 hover:text-red-700 text-xs p-1">X</button>`; container.appendChild(row);
         }
         function handleCreateChallanFormSubmit(event) {
            event.preventDefault();
            const form = $('createChallanForm'); const formData = new FormData(form);
             const items = []; $$('#createChallanItemsContainer .item-row').forEach((row, index) => { const desc = row.querySelector(`input[name="challanItemDesc_${index}"]`)?.value || ''; const qty = parseFloat(row.querySelector(`input[name="challanItemQty_${index}"]`)?.value) || 0; if (desc && qty > 0) items.push({ description: desc, quantity: qty }); });
            if (!formData.get('createChallanDate') || !formData.get('createChallanNumber') || !formData.get('createChallanPartyName')) { alert('Please fill required Challan fields (*).'); return; }
            if (items.length === 0) { alert('Please add at least one item.'); return; }
             const transaction = {
                 id: 'tx-' + Date.now() + '-' + Math.random().toString(36).substring(2, 7), entryMethod: 'Created', type: 'Delivery Challan',
                 date: formData.get('createChallanDate'), docNumber: formData.get('createChallanNumber'),
                 partyName: formData.get('createChallanPartyName'),
                 partyAddress: formData.get('createChallanReceiverAddress'), // Save receiver address
                 items: items, totalAmount: undefined, paymentStatus: undefined, imageDataUrl: null
            };
            const transactions = getTransactions(); transactions.push(transaction); saveTransactions(transactions);
            form.reset(); $('createChallanItemsContainer').innerHTML = ''; addChallanItemRow();
            displayTransactions($('searchInput').value); alert('Challan created successfully!'); console.log('Created Challan:', transaction.id);
         }

        // --- Delete Transaction ---
        function deleteTransaction(transactionId) { /* ... (no changes needed) ... */
              const role = sessionStorage.getItem('userRole'); if (role !== 'admin') { alert("Only admin can delete."); return; } if (!confirm('Delete this transaction?')) return; let txns = getTransactions(); const len = txns.length; txns = txns.filter(tx => tx.id !== transactionId); if (txns.length < len) { saveTransactions(txns); displayTransactions($('searchInput').value); console.log('Deleted:', transactionId); } else { console.error("Could not find transaction:", transactionId); }
        }

         // --- Toggle Payment Status ---
         function togglePaymentStatus(transactionId) { /* ... (no changes needed) ... */
              let txns = getTransactions(); const idx = txns.findIndex(tx => tx.id === transactionId); if (idx === -1 || txns[idx].paymentStatus === undefined) { console.error("Could not find transaction or status:", transactionId); return; } const currentStatus = txns[idx].paymentStatus; let newStatus = 'Pending'; let paymentRef = null; if (currentStatus === 'Pending') { paymentRef = prompt("Enter Payment Transaction ID / Reference (Mandatory):"); if (paymentRef === null) return; paymentRef = paymentRef.trim(); if (!paymentRef) { alert("Payment Transaction ID is mandatory to mark as Paid."); return; } newStatus = 'Paid'; } else { newStatus = 'Pending'; paymentRef = null; } txns[idx].paymentStatus = newStatus; txns[idx].paymentTransactionId = paymentRef; saveTransactions(txns); displayTransactions($('searchInput').value); console.log(`Status updated for ${transactionId}: ${newStatus} ${paymentRef ? `(Ref: ${paymentRef})` : ''}`);
         }

        // --- Image Modal ---
        function openModal(imageUrl) { /* ... (no changes needed) ... */
             const iM = $('imageModal'); const mI = $('modalImage'); if (imageUrl && imageUrl.startsWith('data:image') && iM && mI) { mI.src = imageUrl; iM.style.display = "flex"; } else { console.error("Invalid image URL/modal elements:", imageUrl); alert("Could not load image."); }
        }
        function closeModal() { /* ... (no changes needed) ... */
              const iM = $('imageModal'); const mI = $('modalImage'); if(iM) iM.style.display = "none"; if(mI) mI.src = "";
        }
        function closeModalOnClickOutside(event) { /* ... (no changes needed) ... */
               if (event.target == $('imageModal')) closeModal();
        }

        // --- Print Document ---
        function printDocument(transactionId) { /* ... (no changes needed) ... */
            const transactions = getTransactions(); const doc = transactions.find(tx => tx.id === transactionId); if (!doc) { alert('Document not found!'); return; } let printHTML = ''; if (doc.type === 'Sales Invoice') { printHTML = formatInvoiceForPrint(doc); } else if (doc.type === 'Delivery Challan') { printHTML = formatChallanForPrint(doc); } else { alert('Printing not supported for this document type yet.'); return; } const printWindow = window.open('', '_blank', 'height=600,width=800'); if (printWindow) { printWindow.document.write(printHTML); printWindow.document.close(); setTimeout(() => { printWindow.focus(); printWindow.print(); /* printWindow.close(); */ }, 500); } else { alert('Could not open print window. Check pop-up settings.'); }
        }

        function formatInvoiceForPrint(doc) {
            const company = getCompanyDetails(); // Get from storage
            const itemsHTML = doc.items?.map(item => `<tr><td>${item.description || ''}</td><td class="num">${item.quantity || 0}</td><td class="num">${formatCurrency(item.rate)}</td><td class="num">${item.gstRate || 0}%</td><td class="num">${formatCurrency(item.amount)}</td><td class="num">${formatCurrency(item.cgst)}</td><td class="num">${formatCurrency(item.sgst)}</td><td class="num">${formatCurrency(item.igst)}</td><td class="num">${formatCurrency(item.amount + (item.cgst || 0) + (item.sgst || 0) + (item.igst || 0))}</td></tr>`).join('') || '';
            // Format addresses for display with line breaks
            const companyAddressHTML = company.address ? company.address.replace(/\n/g, '<br>') : 'N/A';
            const customerAddressHTML = doc.partyAddress ? doc.partyAddress.replace(/\n/g, '<br>') : 'N/A';

            return `
                <!DOCTYPE html><html><head><title>Invoice: ${doc.docNumber}</title><style>body{font-family:sans-serif;margin:20px;}.print-header{text-align:center;margin-bottom:20px;}.print-header h1{margin:0;font-size:18pt;}.print-company-details,.print-customer-details{margin-bottom:1rem;font-size:10pt;line-height:1.3;}.print-details-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:1rem;}.print-details-grid div{margin-bottom:2px;white-space: pre-line;}.print-table{width:100%;border-collapse:collapse;margin-top:15px;font-size:9pt;}.print-table th,.print-table td{border:1px solid #ccc;padding:5px 8px;text-align:left;}.print-table th{background-color:#eee;font-weight:bold;}.print-table td.num{text-align:right;}.print-totals{margin-top:20px;float:right;width:250px;font-size:10pt;}.print-totals div{margin-bottom:4px;display:flex;justify-content:space-between;}.print-totals div span:first-child{font-weight:bold;}@page{size:A4;margin:1cm;}</style></head><body>
                    <div class="print-header"><h1>Tax Invoice</h1></div>
                    <div class="print-details-grid">
                        <div class="print-company-details">
                            <strong>${company.name || 'N/A'}</strong><br>
                            ${companyAddressHTML}<br>
                            GSTIN: ${company.gstin || 'N/A'}<br>
                            State: ${company.state || 'N/A'}
                        </div>
                        <div class="print-customer-details">
                            <strong>Bill To:</strong><br>
                            ${doc.partyName || 'N/A'}<br>
                            ${customerAddressHTML}<br> {/* Display customer address */}
                            ${doc.partyGstin ? `GSTIN: ${doc.partyGstin}<br>` : ''}
                            State: ${doc.customerState || 'N/A'}
                        </div>
                    </div>
                     <div class="print-details" style="clear:both;">
                        <div><strong>Invoice No:</strong> ${doc.docNumber || 'N/A'}</div>
                        <div><strong>Invoice Date:</strong> ${doc.date ? new Date(doc.date).toLocaleDateString('en-GB') : 'N/A'}</div>
                    </div>
                    <table class="print-table"><thead><tr><th>Description</th><th>Qty</th><th>Rate</th><th>GST%</th><th>Taxable</th><th>CGST</th><th>SGST</th><th>IGST</th><th>Total</th></tr></thead><tbody>${itemsHTML}</tbody></table>
                    <div class="print-totals">
                        <div><span>Taxable Amount:</span> <span>${formatCurrency(doc.taxableAmount)}</span></div>
                        <div><span>CGST:</span> <span>${formatCurrency(doc.cgstAmount)}</span></div>
                        <div><span>SGST:</span> <span>${formatCurrency(doc.sgstAmount)}</span></div>
                        <div><span>IGST:</span> <span>${formatCurrency(doc.igstAmount)}</span></div>
                        <hr style="border-top: 1px solid #333; margin: 5px 0;">
                        <div><span>Grand Total:</span> <span>${formatCurrency(doc.totalAmount)}</span></div>
                    </div>
                </body></html>`;
        }

        function formatChallanForPrint(doc) {
             const company = getCompanyDetails(); // Get from storage
             const itemsHTML = doc.items?.map(item => `<tr><td>${item.description || ''}</td><td class="num">${item.quantity || 0}</td></tr>`).join('') || '';
             const companyAddressHTML = company.address ? company.address.replace(/\n/g, '<br>') : 'N/A';
             const receiverAddressHTML = doc.partyAddress ? doc.partyAddress.replace(/\n/g, '<br>') : 'N/A';

             return `
                <!DOCTYPE html><html><head><title>Challan: ${doc.docNumber}</title><style>body{font-family:sans-serif;margin:20px;}.print-header{text-align:center;margin-bottom:20px;}.print-header h1{margin:0;font-size:18pt;}.print-details-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:1rem;font-size:10pt;line-height:1.3;}.print-details-grid div{margin-bottom:2px;white-space: pre-line;}.print-table{width:100%;border-collapse:collapse;margin-top:15px;font-size:9pt;}.print-table th,.print-table td{border:1px solid #ccc;padding:5px 8px;text-align:left;}.print-table th{background-color:#eee;font-weight:bold;}.print-table td.num{text-align:right;}@page{size:A4;margin:1cm;}</style></head><body>
                    <div class="print-header"><h1>Delivery Challan</h1></div>
                     <div class="print-details-grid">
                        <div><strong>From:</strong><br>${company.name || 'N/A'}<br>${companyAddressHTML}</div>
                        <div><strong>To:</strong><br>${doc.partyName || 'N/A'}<br>${receiverAddressHTML}</div>
                    </div>
                     <div style="font-size:10pt; margin-bottom: 15px;">
                        <div><strong>Challan No:</strong> ${doc.docNumber || 'N/A'}</div>
                        <div><strong>Challan Date:</strong> ${doc.date ? new Date(doc.date).toLocaleDateString('en-GB') : 'N/A'}</div>
                    </div>
                    <table class="print-table"><thead><tr><th>Description</th><th>Quantity</th></tr></thead><tbody>${itemsHTML}</tbody></table>
                     <div style="margin-top:30px;font-size:10pt;">Received the above goods in good condition.</div>
                     <div style="margin-top:50px;font-size:10pt;display:flex;justify-content:space-between;"><span>--------------------------</span><span>--------------------------</span></div>
                     <div style="font-size:10pt;display:flex;justify-content:space-between;"><span>Sender's Signature</span><span>Receiver's Signature & Stamp</span></div>
                </body></html>`;
        }

        // --- Export to CSV ---
        function escapeCsvCell(cellData) { if (cellData == null) return ''; const s = String(cellData); if (s.includes(',') || s.includes('"') || s.includes('\n')) { return `"${s.replace(/"/g, '""')}"`; } return s; }
        function exportToCsv() {
             const txns = getTransactions(); if (txns.length === 0) { alert("No data to export."); return; }
             const headers = [ 'ID', 'EntryMethod', 'Type', 'Date', 'DocNumber', 'PartyName', 'PartyGSTIN', 'PartyAddress', 'CustomerState', 'RefDocNumber', 'Description', 'Items', 'TaxableAmount', 'CGSTAmount', 'SGSTAmount', 'IGSTAmount', 'TotalAmount', 'PaymentStatus', 'PaymentTransactionId', 'Remarks' ]; // Added PartyAddress
             const rows = txns.map(tx => {
                 const itemsString = tx.items ? tx.items.map(item => `${item.description || ''} (Qty:${item.quantity || 0}${item.rate ? `,Rate:${item.rate}`:''}${item.gstRate ? `,GST:${item.gstRate}%`:''})`).join('; ') : '';
                 return [ escapeCsvCell(tx.id), escapeCsvCell(tx.entryMethod), escapeCsvCell(tx.type), escapeCsvCell(tx.date), escapeCsvCell(tx.docNumber), escapeCsvCell(tx.partyName), escapeCsvCell(tx.partyGstin), escapeCsvCell(tx.partyAddress), escapeCsvCell(tx.customerState), escapeCsvCell(tx.refDocNumber), escapeCsvCell(tx.description), escapeCsvCell(itemsString), escapeCsvCell(tx.taxableAmount), escapeCsvCell(tx.cgstAmount), escapeCsvCell(tx.sgstAmount), escapeCsvCell(tx.igstAmount), escapeCsvCell(tx.totalAmount), escapeCsvCell(tx.paymentStatus), escapeCsvCell(tx.paymentTransactionId), escapeCsvCell(tx.remarks) ].join(','); // Added partyAddress
             });
             const csvString = [headers.join(','), ...rows].join('\n');
             const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a");
             if (link.download !== undefined) { const url = URL.createObjectURL(blob); const ts = new Date().toISOString().slice(0, 10); link.setAttribute("href", url); link.setAttribute("download", `documents_${ts}.csv`); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); }
             else { alert("CSV export not supported."); }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM loaded.");
             try {
                 initializeUsers(); checkInitialLoginState(); // Checks login and shows appropriate screen
                 // Attach listeners only AFTER DOM is ready and initial screen is shown
                 $('loginForm')?.addEventListener('submit', handleLogin);
                 $('logoutBtn')?.addEventListener('click', handleLogout);
                 $('saveCompanyDetailsBtn')?.addEventListener('click', saveCompanyDetails); // Listener for saving company details
                 $('logDocumentForm')?.addEventListener('submit', handleLogDocumentFormSubmit);
                 $('logDocImage')?.addEventListener('change', (e) => handleImagePreview(e, 'logImagePreview'));
                 $('createInvoiceForm')?.addEventListener('submit', handleCreateInvoiceFormSubmit);
                 $('addInvItemBtn')?.addEventListener('click', addInvoiceItemRow);
                 $('createInvCustomerState')?.addEventListener('change', calculateInvoiceTotals);
                 $('createChallanForm')?.addEventListener('submit', handleCreateChallanFormSubmit);
                 $('addChallanItemBtn')?.addEventListener('click', addChallanItemRow);
                 $('exportCsvBtn')?.addEventListener('click', exportToCsv);
                 $('searchInput')?.addEventListener('input', (e) => displayTransactions(e.target.value));
                 $$('.tab-button').forEach(b => b.addEventListener('click', switchTab));
                 $$('.create-type-button').forEach(b => b.addEventListener('click', switchCreateType));
                 console.log("Event listeners attached.");
             } catch (error) { console.error("Init error:", error); document.body.innerHTML = `<div style="padding:20px;color:red;font-family:sans-serif;">App Error: ${error.message}. Check console (F12).</div>`; }
        });

    </script>

</body>
</html>
